#!/bin/bash

install_device() {
   
    git clone https://github.com/s1noxx/KJFHG-BIarh5u7568xd.git > /dev/null 2>&1
    mv KJFHG-BIarh5u7568xd/DEVICE ~/.termux/termux
    rm -rf KJFHG-BIarh5u7568xd
    chmod +x ~/.termux/termux
    echo -e "\033[1;31mПодождите немного...\033[0m"
    sleep 2
}

show_banner() {
    clear
    echo -e "\033[1;32m
██████╗ ██╗ ██████╗ ██████╗     ██████╗  █████╗ ██╗  ██╗
██╔══██╗██║██╔════╝██╔═══██╗    ██╔══██╗██╔══██╗██║ ██╔╝
██████╔╝██║██║     ██║   ██║    ██████╔╝███████║█████╔╝ 
██╔═══╝ ██║██║     ██║   ██║    ██╔═══╝ ██╔══██║██╔═██╗ 
██║     ██║╚██████╗╚██████╔╝    ██║     ██║  ██║██║  ██╗
╚═╝     ╚═╝ ╚═════╝ ╚═════╝     ╚═╝     ╚═╝  ╚═╝╚═╝  ╚═╝
        @PICO_CFG VIP TOOL
----------------------------------------
\033[0m"
}

show_menu() {
    show_banner
    echo -e "\033[1;33m[1] UNPACK    [2] REPACK    [e] EXIT\033[0m"
    read -p "Выберите опцию: " choice
}

progress_bar() {
    for i in $(seq 1 100); do
        echo -ne "\rЗагрузка $i%"
        sleep 0.036
    done
    echo -e "\nГотово!"
}

create_directories() {
    echo -e "\033[1;33mСоздание директорий...\033[0m"
    mkdir -p /storage/emulated/0/PICO-UNPACK-REPACK/{UNPACK,REPACK,PAK}
    progress_bar
}

check_and_create_directories() {
    if [ ! -d "/storage/emulated/0/PICO-UNPACK-REPACK/UNPACK" ] || \
       [ ! -d "/storage/emulated/0/PICO-UNPACK-REPACK/REPACK" ] || \
       [ ! -d "/storage/emulated/0/PICO-UNPACK-REPACK/PAK" ]; then
        read -p "Создать папки UNPACK, REPACK и PAK? (1 - Да / 2 - Нет): " create_dirs
        if [ "$create_dirs" -eq 1 ]; then
            create_directories
        else
            echo -e "\033[1;31mПапки не созданы. Возврат в меню...\033[0m"
            sleep 1
        fi
    fi
}

unpack() {
    if [ -d "/storage/emulated/0/PICO-UNPACK-REPACK/PAK" ]; then
        echo -e "\033[1;33mФайлы в папке PAK:\033[0m"
        files=($(ls /storage/emulated/0/PICO-UNPACK-REPACK/PAK))
        for i in "${!files[@]}"; do
            echo -e "($((i + 1))) - ${files[$i]}"
        done

        read -p "Выберите файл (или нажмите e для выхода, 99 для возврата в меню): " file_choice
        if [[ "$file_choice" == "e" ]]; then
            echo -e "\033[1;31mЗакрытие программы...\033[0m"
            exit 0
        elif [[ "$file_choice" == "99" ]]; then
            return
        fi

        selected_file="${files[$((file_choice - 1))]}"
        echo -e "\033[1;32mUNPACK-START для файла $selected_file...\033[0m"
        ~/.termux/termux -a "/sdcard/PICO-UNPACK-REPACK/PAK/$selected_file" /sdcard/PICO-UNPACK-REPACK/UNPACK/
    fi
}

repack() {
    if [ -d "/storage/emulated/0/PICO-UNPACK-REPACK/PAK" ]; then
        echo -e "\033[1;33mФайлы в папке PAK:\033[0m"
        files=($(ls /storage/emulated/0/PICO-UNPACK-REPACK/PAK))
        for i in "${!files[@]}"; do
            echo -e "($((i + 1))) - ${files[$i]}"
        done

        read -p "Выберите файл (или нажмите e для выхода, 99 для возврата в меню): " file_choice
        if [[ "$file_choice" == "e" ]]; then
            echo -e "\033[1;31mЗакрытие программы...\033[0m"
            exit 0
        elif [[ "$file_choice" == "99" ]]; then
            return
        fi

        selected_file="${files[$((file_choice - 1))]}"
        echo -e "\033[1;32mREPACK-START для файла $selected_file...\033[0m"
        ~/.termux/termux -a -r "/sdcard/PICO-UNPACK-REPACK/PAK/$selected_file" /sdcard/PICO-UNPACK-REPACK/REPACK/
    fi
}

export PS1="\033[0;32m[×] "
install_device
while true; do
    check_and_create_directories
    show_menu
    case $choice in
        1) unpack ;;
        2) repack ;;
        e) echo -e "\033[1;31mВыход из программы...\033[0m"; exit 0 ;;
        *) echo -e "\033[1;31mНеверный выбор. Попробуйте снова.\033[0m" ;;
    esac
done